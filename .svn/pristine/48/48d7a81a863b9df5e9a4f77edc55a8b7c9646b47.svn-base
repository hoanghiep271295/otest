/**
 * Các hình thức câu hỏi thi khác nhau
/* MC: câu hỏi một nhiều – có một nhóm câu hỏi,
 * sau đó có câu hỏi chi tiết và danh sách câu trả lời.

/* MS: câu hỏi một nhiều chỉ dành cho một câu hỏi cho một nhóm;
 * Câu hỏi ỏ nhóm, tự động sinh ra một bản ghi câu hỏi giả để lien kết, sau đó có các đáp án.

/* PA: câu hỏi dạng ghép đôi - hiển thị một danh sách các câu hỏi bên trái,
 * danh sách các câu hỏi bên phải ghép lại thành cặp. Có một câu hỏi chung ở đầu; danh sách câu hỏi, danh sách câu trả lời.

/* FI: Câu hỏi điền vào đoạn trống - Có một đoạn các câu hỏi và
 * sau đó có danh sách các đáp án (có thể dư hoặc không dư) để điền vào. Có câu hỏi chung lớn – group; các câu hỏi chi tiết là số thứ tự; Câu trả lời tương ứng. (Tự động sinh ra câu hỏi và câu trả lời từ đoạn văn bản)

/* FG: Câu hỏi điền vào đoạn trống tự gõ từ - Có một đoạn các câu hỏi và
 * sau đó người thi phải tự điền từ thích hợp vào ô trống. Các thức tiến hành giống ở trên,
 * khác chỗ hiển thị ra câu cho phép kéo vào, ngoài ra cho phép thêm các đáp án giả.

/* CO: Dạng câu hỏi tổng kết - cho một đoạn đọc (chính);
 * sau đó tiến hành đưa ra một câu hỏi và có nhiều đáp án trả lời độc lập - true/false, true/false/not given

/* RW: Viết lại câu; (câu hỏi chính ở nhóm), sau đó câu hỏi chi tiết chính là các từ;
 * Một câu hỏi có thể có nhiều đáp án đúng (để cho phép so sánh chỉ cần đúng một trong các đáp án đó là tính điểm)

/* LA: Nghe nói - lưu lại một file không có answer; Chỉ có nhóm câu hỏi – tự động tạo một bản ghi trong question,
* WR:Bài viết (tự luận); Chỉ có câu hỏi ở nhóm;
 */
var App = React.createClass({
    getInitialState: function () {
        return {
            listGroupQuesion: [],//danh sách nhóm câu hỏi theo examtimedetail
            listQuestion: [], //danh sách các câu hỏi theo nhóm câu hỏi
            listAnswer: [],// danh sách các câu trả lời theo câu hỏi và nhóm câu hỏi
            objHalltudent: null,// phòng thi của sinh viên
            objExamForm: null,// đề thi
            listExamDetail: [],//chi tiết đề thi
            listStudentAnswer: [],//danh sách kết quả của sinh viên
            numberQuestion: 0// số lượng câu hỏi đưa xuống, việc đếm sô lượng câu hỏi sẽ cho sinh viên biết
            //đã làm được bao nhiêu câu, khi sinh viên commit bài thi sẽ thông báo đã hoàn thành hết số câu hỏi hay chưa
        }
    },
    componentWillMount: function () {

    },
    //Khi muốn load dữ liệu thì phải để willmount để theo đúng vòng đời của react will-render-did
    componentDidMount: function () {
        this.loadData();
        //hàm này để truyền con trỏ this ra ngoài để bên ngoài có thể thao tác được với biến this
        window.getApp(this);
    },
    //khi chưa có sinh viên vào thì đang fake dữ liệu
    loadData: function () {
        var defaultvalue = window.getDefaultFromServer();
        var markcode = defaultvalue.markcode;
        var examtimecode = defaultvalue.examtimecode;
        $.ajax({
            url: "/studentexam/GetDetailExam",
            dataType: 'json',
            data: {
                markcode: markcode, // mã sinh viên trong bảng điểm của một lớp môn học
                examtimecode: examtimecode //mã đợt thi Đợt thi
            },
            success: function (data) {
                if (data.ret >= 0) {
                    this.setState({
                        listGroupQuesion: data.liQuestiongroup,
                        listQuestion: data.li_question,
                        listAnswer: data.li_answer,
                        objHalltudent: data.ObjexamHallstudent,
                        objExamForm: data.ObjexamForm,
                        listExamDetail: data.liExamformDetail,
                        numberQuestion: data.numberQuestion
                    });
                    //  console.log(data.listGroupQuesion);
                }
            }.bind(this),
            error: function (xhr, status, err) {
                console.log(err.toString());
            }
        });
    },
    //submit data to server, format data to json string before
    onSubmit: function () {
        var list = JSON.stringify(this.state.listStudentAnswer);
        var listExamdetail = JSON.stringify(this.state.listExamDetail);
        var examformcode = JSON.stringify(this.state.objExamForm);
        $.ajax({
            url: "/ExamResult/UpdateExamResult",
            dataType: 'json',
            type: 'POST',
            data: {
                listobj: list,
                examformcode: examformcode,
                listexamformdetail: listExamdetail,
                examhallstudentcode: this.state.objHalltudent.CODE
            },
            success: function (data) {
                if (data.ret >= 0) {
                    log.show('Finished !!', true);
                }
            }.bind(this),
            error: function (xhr, status, err) {
                console.log(err.toString());
            }
        });
    },
    /**
     * @param {string} mach -  Questioncode
     * @param {string} mctl - sometimes here is answercode, sometimes here is answer text
     * @param {string} thetype - Type of answer : MC,PA,LA,FI,FG,RW,WR or default is none
     * @returns {} push answer into this state
     */
    onCheck(mach, mctl, thetype) {
        var obj = new Object();
        obj.MaCauHoi = mach;
        obj.MaCauTL = mctl;
        obj.TYPE = thetype;
        // var ques = {MaCauHoi:mach,MaCauTL:mctl,TYPE:thetype};
        //check the existence of this obj in db
        var check = this.containsObject(obj, this.state.listStudentAnswer);
        console.log(this.state.listStudentAnswer);
        //if update we will update
        if (check) {
            this.updateObject(obj, this.state.listStudentAnswer);
            //this.onSubmit();
        } //add new
        else {
            this.state.listStudentAnswer.push(obj);
            //this.onSubmit();
        }
    },
    /**
     * check extistence of an object
     * @param {object} obj
     * @param {list<>} list
     * @returns {boolean}
     */
    containsObject: function (obj, list) {
        for (var i = 0; i < list.length; i++) {
            if (list[i].MaCauHoi === obj.MaCauHoi) {
                return true;//exist
            }
        }
        //none exist
        return false;
    },
    /**
     * check an object in arr and update it
     * @param {Object} đối ượng cần kiểm trả xem đã tồn tại trong mảng hay chưa
     * @param {Arr<>} arr mảng lưu trữ danh sách đáp án
     * @returns {}
     */
    updateObject: function (obj, arr) {
        for (var i in arr) {
            if (arr.hasOwnProperty(i)) {
                if (arr[i].MaCauHoi === obj.MaCauHoi) {
                    arr[i].MaCauTL = obj.MaCauTL;
                    arr[i].TYPE = obj.TYPE;
                    break; //Stop this loop, we found it!
                }
            }
        }
    },

    render: function () {
        var listQgroup = [];
        var index = 0;
        var that = this;
        this.state.listGroupQuesion.forEach(function (rowitem) {
            index++;
            switch (rowitem._QUESTIONTYPECODE.CODEVIEW) {
                //multichoice
                //một câu hỏi lớn và danh sách các câu hỏi nhỏ, trong các câu hỏi nhỏ thì sẽ có các câu trả lời
                case 'MC':
                    listQgroup.push(<QuestionGroup key={index}
                                                   number={index}
                                                   ident={rowitem.CODE}
                                                   onCheck={that.onCheck}
                                                   objQuestionGroup={rowitem.CONTENT}
                                                   dataQuestion={that.state.listQuestion}
                                                   dataAnswer={that.state.listAnswer}
                                                   questiontype={"MC"}
                                                   listAnswer={that.state.listStudentAnswer} />);
                    break;
                    // Single choice
                    //dạng này không khác dạng multichoice cho lắm, chỉ hơi khác là chỉ gồm có 1 câu hỏi lớn và trong đó là các câu trả lời luôn
                    //chứ không cần phải nhập câu hỏi nữa, khi nhập liệu thì dạng này đã tự động sinh ra 1 bản ghi là 1 question rồi

                case 'MS':
                    listQgroup.push(<QuestionTypeMS key={index}
                                                    number={index}
                                                    ident={rowitem.CODE}
                                                    onCheck={that.onCheck}
                                                    objQuestionGroup={rowitem.CONTENT}
                                                    dataQuestion={that.state.listQuestion}
                                                    dataAnswer={that.state.listAnswer}
                                                    questiontype={"MS"}
                                                    listAnswer={that.state.listStudentAnswer} />);

                    break;
                    //Co; Trường hợp câu hỏi tổng hợp, thực hiện giống như câu hỏi một nhiều
                    //2


                case 'CO':
                    listQgroup.push(<QuestionGroup key={index}
                                                   number={index}
                                                   ident={rowitem.CODE}
                                                   onCheck={that.onCheck}
                                                   objQuestionGroup={rowitem.CONTENT}
                                                   dataQuestion={that.state.listQuestion}
                                                   dataAnswer={that.state.listAnswer}
                                                   questiontype={"CO"}
                                                   listAnswer={that.state.listStudentAnswer} />);
                    break;


                    //recording
                    //3
                case 'LA':
                    listQgroup.push(<QuestionGroup key={index}
                                                   number={index}
                                                   ident={rowitem.CODE}
                                                   objQuestionGroup={rowitem.CONTENT}
                                                   dataQuestion={that.state.listQuestion}
                                                   questiontype={"LA"}
                                                   onCheck={that.onCheck}
                                                   listAnswer={that.state.listStudentAnswer} />);
                    break;
                    //writing
                    //4
                    //case 'WR':
                    //    listQgroup.push(<QuestionTypeWR key={index}
                //                                   number={index}
                //                                   ident={rowitem.CODE}
                //                                   objQuestionGroup={rowitem.CONTENT}
                //                                   dataQuestion={that.state.listQuestion}
                //                                   onCheck={that.onCheck}
                //                                   questiontype={"WR"} />);
            //    break;
                case 'WR':
                    listQgroup.push(<QuestionGroup key={index}
                                                    number={index}
                                                    ident={rowitem.CODE}
                                                    objQuestionGroup={rowitem.CONTENT}
                                                    dataQuestion={that.state.listQuestion}
                                                    onCheck={that.onCheck}
                                                    questiontype={"WR"} />);
                                                            break;
                    // FG: Câu hỏi điền vào đoạn trống tự gõ từ
                    //5
                case 'FG':
                    listQgroup.push(<QuestionTypeFG key={index}
                                                    ref="child"
                                                    number={index}
                                                    objQuestionGroup={rowitem}
                                                    onCheck={that.onCheck}
                                                    questiontype={"FG"} />);
                                            break;
                 case 'FI':
                                            ////debugger
                                            listQgroup.push(<QuestionTypeFI key={index}
                                                                            number={index}
                                                                            quesGroupCode={rowitem.CODE}
                                                                            dataAnswer={that.state.listAnswer}
                                                                            objQuestionGroup={rowitem}
                                                                            onCheck={that.onCheck}
                                                                            questiontype={"FI"} />);
                                            break;
                                            // RW: rewrite
                                            //6
                case 'RW':
                                            //  debugger
                                            listQgroup.push(<QuestionGroup key={index}
                                                                           number={index}
                                                                           ident={rowitem.CODE}
                                                                           objQuestionGroup={rowitem.CONTENT}
                                                                           dataQuestion={that.state.listQuestion}
                                                                           dataAnswer={that.state.listAnswer}
                                                                           onCheck={that.onCheck}
                                                                           questiontype={"RW"} />);
                                            break;

                default:
                                            console.log('chua lam');
                                            break;
                                            }
                                            });

                                            return (
        <div className="examform">

            {listQgroup}
                <div style={{margin:'10px'}}>
                 <button onClick={this.onSubmit} style={{fontFamily:'Verdana,sans-serif'}} id="btnSubmit"
                         className="btn btnSubmit">
                     Submit Your Answer »
                 </button>
                </div>
        </div>
        );
}
});

//nhóm câu hỏi
// từ đây sẽ hiển thị ra đơợc danh sách các câu hỏi con  và 1 câu hỏi lớn
var QuestionGroup = React.createClass({
    render: function () {
        var listQuestion = [];
        var index = 0;
        var that = this;
     //   console.log(this.props.dataQuestion);
        this.props.dataQuestion.forEach(function (rowitem) {
            if (rowitem.QUESTIONGROUPCODE === that.props.ident) {
                index++;
                listQuestion.push(<Question key={index}
                                            index={index}
                                            iden={rowitem.CODE}
                                            objQuestion={rowitem}
                                            listanswer={that.props.dataAnswer}
                                            onCheck={that.props.onCheck}
                                            questiontype={that.props.questiontype} />);
            }
        });
        var id = this.props.ident;
        var questiongroup = $("<div />").html(this.props.objQuestionGroup).text();
        return (
                <div>
                    <div className="container questiongroup">
                 <h4 style={{fontWeight:'bold'}}>{this.props.number}.</h4>
                    </div>
                    <div>
                <div style={{position:'relative'}}>
                        <fieldset className="fieldsetGroup">
                     <span key={'error_'+ id} dangerouslySetInnerHTML={{ __html: questiongroup}}></span>
            <ul>
                {listQuestion}
            </ul>
                        </fieldset>
                </div>
                    </div>
                </div>
            );
    }
});
///multichoice
var QuestionTypeMS = React.createClass({
    /**
    * @param {} e
    * @returns {} answer of Multichoice question
    */
    onChangeMS: function(e) {
        var mch = e.target.name;
        var mctl = e.target.id;
        this.props.onCheck(mch, mctl, "MS");
    },
    render() {
        var that = this;
        var index = 0;
        var listanswer = [];
    
        this.props.dataAnswer.forEach(function(rowitem) {
            index++;
            if (rowitem.QUESTIONGROUPCODE === that.props.ident) {
                var answer = $("<div />").html(rowitem.CONTENT).text();
                listanswer.push(
                    <li key={index} className='flex-item' name={rowitem.QUESTIONCODE}>
                        <input type="radio" id={rowitem.CODE} name={rowitem.QUESTIONCODE} onClick={that.onChangeMS} />
                        &nbsp; &nbsp;&nbsp; &nbsp;
                        <label id={index} htmlFor={rowitem.CODE}>
                <span style={{ 'textAlign' : 'left' }} key={'error_' + index}
                      dangerouslySetInnerHTML={{ __html : answer }}></span>
                  </label>
                    </li>
  );
            }
});
                    var id = this.props.ident;
                    var questiongroup = $("<div />").html(this.props.objQuestionGroup).text();
        return (
              <div>
                    <div className="container questiongroup">
                 <h4 style={{fontWeight:'bold'}}>{this.props.number}.</h4>
                    </div>
                    <div>
                <div style={{position:'relative'}}>
                        <fieldset className="fieldsetGroup">
                     <span key={'error_'+ id} dangerouslySetInnerHTML={{ __html:  questiongroup}}></span>
        <ul className="list-unstyled flex-container" style={{ 'marginBottom': '20px' }}>
            {listanswer}
        </ul>
                        </fieldset>
                </div>
                    </div>
              </div>
);
            }
            });
//show questiongroup
//show question
var Question = React.createClass({
    /**
     * reder data
     * @returns {}
     */
    render: function () {
        var listanswer = [];//danh sach cau tra loi
        var that = this;// vì không thể để this trong this, vì điều này làm confuse cho việc kiểm soát,nên nó không thể hiểu được this trong this là gì
        //đo là lý do phải làm that  =this nhìn ngu ngu này
        var questiontype = this.props.questiontype;//dạng câu hỏi
        // debugger
        switch (questiontype) {
            //vì mỗi câu hỏi có nhiều đáp án khác nhau nên render luôn tại đây
            //1
            case 'MC':
                listanswer = (<QuestionTypeMC idMC={that.props.iden}
                                              onCheck={that.props.onCheck}
                                              listanswer={this.props.listanswer} />);
                break;
                //Giống hệt như dạng multichoice chỉ khác một chút là ở đây thay vì việc lấy dữ liệu từ
                //câu hỏi question để hiện thị làm câu hỏi chính thì lấy từ nội dung của questiontype
                //2
                //case 'MS':
                //    listanswer = (<QuestionTypeMS idMS={that.props.iden}
            //                                  onCheck={that.props.onCheck}
            //                                  listanswer={this.props.listanswer} />);
        //                                break;
        //Cau hoi tong hop
        //dạng  này tương tự trên
        //2
            case 'CO':
                listanswer = (<QuestionTypeCO idCO={that.props.iden}
                                              onCheck={that.props.onCheck }
                                              listanswer={this.props.listanswer} />);
                                    break;
                                    //nghe noi
                                    //dạng này thì khác, vị trí của câu trả lời hơi khó để viết tại đây luôn lên cho ra ngoài thành component để hiển thị cho dễ
                                    //3
                                                case 'LA':
                                    listanswer = (<Recorder id={that.props.iden}
                                                            onCheck={that.props.onCheck } />);
                                    break;
                                    ////writing
                                    ////tương tự writing cũng làm như vậy,tạo component riêng, tuy nhiên thì nên để đây render luôn thì đẹp nhất
                                    ////4
                                    //dạng này tách ra mà viết khong cần duyệt qua question
                                                case 'WR':
                                    //  listanswer = (<QuestionTypeWR idWR={+that.props.iden + 'WR'} onCheck={that.props.onCheck }  />);
                                    listanswer=(<Writing id={+that.props.iden+'WR'} onCheck={that.props.onCheck} />);
                                    break;
                                    //FG: Dien tu vao o trong go tu
                                    //5
                                                case 'FG':
                                    console.log("FG question, do nothing here, we did id before this component");
                                    break;
                                    //Viet lai cau
                                    //xác địn mỗi câu hỏi có nhiều câu trả lời đúng, tuy nhiên chỉ cho nhập 1 lần để so sánh với danh sách câu trả lời đúng
                                    //6
                                    case 'RW':
                                    listanswer = (<QuestionTypeRW idRW={+that.props.iden + 'RW'} onCheck={that.props.onCheck } />);
                                    break;
                                    default:
                                    log.show('abc', true);
                                    break;
                     }
                            var index = this.props.index;
                            var question = $('<div />').html(this.props.objQuestion.CONTENT).text();
                            return (
                             <div>
                              <li style={{ 'listStyle':'none'}}>
                              <div className="container questiongroup">
                                   <div className="col-sm-1" style={{ fontWeight:'bold' , fontFamily :'Times New Roman,serif' , fontSize:'13.0pt' }}>
                                       {this.props.index}.
                                   </div>
                            <div className="col-sm-10">
                                           <span style={{ textAlign:'left' }} key={'error_'+ index} dangerouslySetInnerHTML={{ __html: question }}></span>
                            </div>
                              </div>
                            <ul className="list-unstyled flex-container" style={{'marginBottom':'20px'}}>
                                {listanswer}
                            </ul>
                              </li>
                             </div>
            );}
});
//writing answer
var QuestionTypeWR = React.createClass({
    /**
    * when any key up on this field will auto update and put it into listAstudentanswer
    * @returns {}
    */
    onSubmit: function () {
        //   debugger
        var index = this.props.idWR+"WR";
        var answer = $('#' + index).val();
        if (!!answer) {
            log.show("writing sent", true);
            index = index.replace("WR", "");
            var mch = index;
            this.props.onCheck(mch, answer, "WR");
        }
    },
    render: function () {
        var questiongroup = $("<div />").html(this.props.objQuestionGroup).text();
        return (
              <div>
                    <div className="container questiongroup">
                 <h4 style={{fontWeight:'bold'}}>{this.props.number}.</h4>
                    </div>
                    <div>
                <div style={{position:'relative'}}>
                        <fieldset className="fieldsetGroup">
                     <span key={'error_'+ this.props.idWR} dangerouslySetInnerHTML={{ __html: questiongroup}}></span>

                           <textarea id={this.props.idWR +"WR"} className="form-control flex-item textareawriting"
                               onBlur={this.onSubmit}></textarea>
                             </fieldset>
                        </div>
                        </div>
                        </div>
            );
}
});


///multichoice
var QuestionTypeMC = React.createClass({
    /**
    * @param {} e
    * @returns {} answer of Multichoice question
    */
    onChangeMC: function(e) {
        var mch = e.target.name;
        var mctl = e.target.id;
        this.props.onCheck(mch, mctl, "MC");
    },
    render() {
        var that = this;
        var indent = 0;
        var listanswer = [];
        this.props.listanswer.forEach(function(rowitem) {
            indent++;
            if (rowitem.QUESTIONCODE === that.props.idMC) {
                var answer = $("<div />").html(rowitem.CONTENT).text();
                listanswer.push(
                    <li key={indent} className='flex-item' name={rowitem.QUESTIONCODE}>
                        <input type="radio" id={rowitem.CODE} name={rowitem.QUESTIONCODE} onClick={that.onChangeMC} />
                        &nbsp; &nbsp;&nbsp; &nbsp;
                        <label id={indent} htmlFor={rowitem.CODE}>
                            <span style={{ textAlign: 'left' }} key={'error_' + indent}
                                  dangerouslySetInnerHTML={{ __html: answer }}></span>
                        </label>
                    </li>
              );
            }
        });
        return (<div>
                    <ul className="list-unstyled flex-container" style={{ 'marginBottom': '20px' }}>
                        {listanswer}
                    </ul>
        </div>
     );
    }
});

//CO
var QuestionTypeCO = React.createClass({
    /**
   * @param {} e
   * @returns {} answer of CO Question
   */
    onChangeCO: function(e) {
        var mch = e.target.name;
        var mctl = e.target.id;
        this.props.onCheck(mch, mctl, "CO");
    },
    render() {
        var listanswer = [];
        var indent = 0;
        var that = this;
        this.props.listanswer.forEach(function(rowitem) {
            indent++;
            if (rowitem.QUESTIONCODE === that.props.idCO) {
                var answer = $("<div />").html(rowitem.CONTENT).text();
                listanswer.push(
                    <li key={indent} style={{ display: 'inline' }} name={rowitem.QUESTIONCODE}>
                        <input type="radio" id={rowitem.CODE} name={rowitem.QUESTIONCODE} onClick={that.onChangeCO} />
                        &nbsp; &nbsp;&nbsp; &nbsp;
                        <label id={indent} htmlFor={rowitem.CODE}>
                            <span style={{ textAlign: 'left' }} key={'error_' + indent} dangerouslySetInnerHTML={{ __html: answer }
                        }></span>
                        </label>
                    </li>
                );
            }
        });
        return(
         <div>
                   <ul className="list-unstyled flex-container" style={{'marginBottom':'20px'}}>
                       {listanswer}
                   </ul>
         </div>
 );}
});


//FI Question,first render questiongroup htmldrangerous
//render ul contain list answer
var QuestionTypeFI = React.createClass({
    preventDefault: function (event) {
        event.preventDefault();
        log.show("preventDefault", true);
    },
    drop: function (ev) {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("text");
        ev.target.appendChild(document.getElementById(data));
        log.show("drop", true);
    },
    dragStart: function (event) {
        event.dataTransfer.setData("text", event.target.id);
        log.show("dragStart", true);
    },
    dragEnter: function (event) {
        log.show("dragEnter", true);
        if (event.target.className === "droptarget") {
            event.target.style.border = "3px dotted red";
            event.target.style.background = "#3CE9FF";
        }
    },
    dragLeave: function (event) {
        log.show("dragLeave", true);
        if (event.target.className === "droptarget") {
            event.target.style.border = "";
            event.target.style.background = "#F5EDB2";
        }
    },
    render() {
        var questiongroupcontent = $("<div />").html(this.props.objQuestionGroup.CONTENT).text().trim();
        var listanswer = [];
        var idquesQg = this.props.quesGroupCode;
        var value = 0;
        this.props.dataAnswer.map(function (rowitem) {
            if (rowitem.QUESTIONGROUPCODE === idquesQg) {
               
                listanswer.push(
             <Drag key={value} id={rowitem.CODE} content={rowitem.CONTENT} />
                            );}
            value++;
        });
        return (
                <div>
                <div className="container questiongroup">
                <h4 style={{fontWeight:'bold'}}>{this.props.number}.</h4>
                </div>
                    <fieldset className="fieldsetGroup">
                       <ul className="gridContent">
                           {listanswer}
                       </ul>
                    </fieldset>
                <div style={{'marginTop':'20px'}}>
                <div style={{position:'relative'}}>
                   <fieldset className="fieldsetGroup" style={{lineHeight: '2.3em' }}>
                         <span key={'error_'+ this.props.objQuestionGroup.CODE} dangerouslySetInnerHTML={{ __html: questiongroupcontent}}></span>
                   </fieldset>
                </div>
                </div>
                </div>
                );
    }
});

var Drag = React.createClass({
    preventDefault: function (event) {
        event.preventDefault();
        log.show("preventDefault", true);
    },
    drop: function (ev) {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("text");
        ev.target.appendChild(document.getElementById(data));
        log.show("drop", true);
    },
    dragStart: function (event) {
        event.dataTransfer.setData("text", event.target.id);
        log.show("dragStart", true);
    },
    dragEnter: function (event) {
        log.show("dragEnter", true);
        if (event.target.className === "droptarget") {
            event.target.style.border = "3px dotted red";
            event.target.style.background = "#3CE9FF";
        }
    },
    dragLeave: function (event) {
        log.show("dragLeave", true);
        if (event.target.className === "droptarget") {
            event.target.style.border = "";
            event.target.style.background = "#F5EDB2";
        }
    },
    render() {
        return (
            <li  className="box"
                 id={this.props.id+'FI'}
                 onDrop={this.drop} 
                 onDragOver={this.preventDefault} 
                 onDragLeave={this.dragLeave} 
                 onDragEnter={this.dragEnter}
                 onDragStart={this.dragStart} >
                 <div className="contentsFI"  >
                        <p>
                            {this.props.content}
                        </p>
                 </div>
            </li>);
    }
});

//FG question
var QuestionTypeFG = React.createClass({
    getAbc: function () {
        console.log("abc");
    },
    sent: function () {
        $("#btnSendFG").removeClass("btn-default");
        $("#btnSendFG").addClass("btn-success");
        $("#btnSendFG").html("Sent");
    },
    render: function () {
        var questiongroupcontent = $("<div />").html(this.props.objQuestionGroup.CONTENT).text();
        return (
            <div>
        <div className="container questiongroup">
     <h4 style={{fontWeight:'bold'}}>{this.props.number}.</h4>
        </div>
        <div>
    <div style={{position:'relative'}}>
   <fieldset className="fieldsetGroup" style={{lineHeight: '2.3em'}}>
         <span key={'error_'+ this.props.objQuestionGroup.CODE} dangerouslySetInnerHTML={{ __html: questiongroupcontent}}></span>
   </fieldset>
    </div>
        </div>
            </div>
            );
    }
});

var Recorder = React.createClass({
    saveAudio: function () {
        var index = this.props.id;//mã câu hỏi
        var va = $('#hid' + index).val();//tìm dữ liệu đã lưu trong hidden
        console.log('Du lieu len:', va);
        this.props.onCheck(index, va, "LA");//tiến hành đẩy vào trong danh sách câu trả lời của sinh viên
    },
    componentDidMount: function () {
        var index = this.props.id;
        const script = document.createElement("script");
        script.type = "text/javascript";
        script.async = true;
        script.innerHTML = 'var minutesLabel' + index + ' = document.querySelector(\'#minutes' + index + '\');\nvar secondsLabel' + index + ' = document.querySelector(\'#seconds' + index + '\');\nvar totalSeconds = 0;\n// setInterval(setTime, 1000);\n\nfunction setTime' + index + '() {\n  ++totalSeconds;\n  secondsLabel' + index + '.innerHTML = pad(totalSeconds % 60);\n  minutesLabel' + index + '.innerHTML = pad(parseInt(totalSeconds / 60));\n}\n\nfunction pad(val) {\n  var valString = val + "";\n  if (valString.length < 2) {\n    return "0" + valString;\n  }\n  else {\n    return valString;\n  }\n}\n\nvar chunks = [];\nvar record' + index + ' = document.querySelector(\'#record' + index + '\');\nvar stop' + index + ' = document.querySelector(\'#stop' + index + '\');\nvar soundClips' + index + ' = document.querySelector(\'#sound-clips' + index + '\');\nvar pause' + index + ' = document.querySelector(\'#pause' + index + '\');\n// kh\u1EDFi t\u1EA1o media recoder \n// read doc t\u1EA1i. https://developer.mozilla.org/en-US/docs/Web/API/MediaRecorder/start \nif (navigator.mediaDevices) {\n  console.log(\'getUserMedia supported.\');\n\n  var constraints = { audio: true };\n\n  document.getElementById(\'record' + index + '\').onclick = function () {\n console.log(\'Chạy cái gì dây\',navigator.mediaDevices); \n   navigator.mediaDevices.getUserMedia(constraints)\n      .then(function (stream) {\n        var mediaRecorder = new MediaRecorder(stream);\n        var _time, time = 0;\n        //   mediaRecorder.onstop\n\n        if (mediaRecorder.state === "paused") {\n            document.querySelector(\'#record' + index + '\').disabled = true;\n          mediaRecorder.resume();\n          console.log(mediaRecorder.state);\n          //\n          _time = setInterval(setTime' + index + ', 1000);\n        }\n        else if (mediaRecorder.state !== \'recording\') {\n          mediaRecorder.start();\n          console.log(mediaRecorder.state);\n          //\n          _time = setInterval(setTime' + index + ', 1000);\n        }\n        ///pause onclick\n        pause' + index + '.onclick = function () {\n\n          if (mediaRecorder.state == \'recording\') {\n        document.querySelector(\'#record' + index + '\').disabled = true;\n            mediaRecorder.pause();\n            clearInterval(_time);\n\n          } else {\n            mediaRecorder.resume();\n            _time = setInterval(setTime' + index + ', 1000);\n          }\n          console.log(mediaRecorder.state);\n\n        }\n        //stop onclick\n        stop' + index + '.onclick = function () {\n          mediaRecorder.stop();\n          console.log(mediaRecorder.state);\n\n          clearInterval(_time);\n          totalSeconds = 0;\n        }\n\n        mediaRecorder.onstop = function (e) {\n          document.querySelector(\'#record' + index + '\').disabled = true;\n          document.querySelector(\'#pause' + index + '\').disabled = true;\n          console.log("data available after MediaRecorder.stop() called.");\n      \n         \n                \n\n\n          var clipContainer = document.createElement(\'article\');\n          var clipLabel = document.createElement(\'p\');\n          var audio = document.createElement(\'audio\');\n          var deleteButton = document.createElement(\'button\');\n          deleteButton.className = "btn btn-danger";\n\n          clipContainer.classList.add(\'clip\');\n          audio.setAttribute(\'controls\', \'\');\n          deleteButton.innerHTML = "Delete";\n        \n\n          clipContainer.appendChild(audio);\n          clipContainer.appendChild(clipLabel);\n          clipContainer.appendChild(deleteButton);\n          soundClips' + index + '.appendChild(clipContainer);\n\n          audio.controls = true;\n          var blob = new Blob(chunks, { \'type\': \'audio/ogg; codecs=opus\' });\n           var fd = new FormData();\n           fd.append(\'filename\', \'' + index + '.wav\');\n                fd.append(\'data\', blob,\'' + index + '.wav\');\n                $.ajax({\n                    type: \'POST\',\n                    url: \'ExamResult/UploadBlob\',\n                    data: fd,\n                    processData: false,\n                    contentType: false\n                }).done(function(data) {\n                       console.log(data);\n                });\n           console.log(blob);\n          var audioURL = URL.createObjectURL(blob);\n          audio.src = audioURL;\n          var url = document.URL;\n          console.log(url);\n          console.log(audioURL);\n          console.log("recorder stopped");\n $("#hid' + index + '").val("' + index + '.wav") ;\n\n          deleteButton.onclick = function (e) {\n\n            evtTgt = e.target;\n            evtTgt.parentNode.parentNode.removeChild(evtTgt.parentNode);\n            chunks = [];\n            document.querySelector(\'#record' + index + '\').disabled = false;\n            document.querySelector(\'#pause' + index + '\').disabled = false;\n          }\n        }\n\n        mediaRecorder.ondataavailable = function (e) {\n          \n          chunks.push(e.data);\n           console.log(e.data); \n\n          console.log(chunks);\n\n          clearInterval(_time);\n          secondsLabel' + index + '.innerHTML = "00";\n          minutesLabel' + index + '.innerHTML = "00";\n        }\n      })\n  }\n}';
        document.body.appendChild(script);
    },
    render: function () {
        var index = this.props.id;
        return (
            <div className="flex-item" style={{width:'auto',margin:'auto'}}>
                <div className="flex-item" style={{marginLeft:'20px'}}>
                <label id={'minutes'+index}>00</label>:<label id={'seconds'+index}>00</label>
                </div>
               <div style={{display:"flex",flexDirection:"row",paddingLeft:'10px',paddingBottom:'40px'}}>
                  <button className="btn btn-danger btnmarginright" id={'record'+ index}>Record <i className="fa fa-microphone" aria-hidden="true"></i></button>
                  <button className="btn btn-group btnmarginright" id={'pause'+ index}>Pause <i className="fa fa-pause" aria-hidden="true"></i></button>
                  <button className="btn btn-info btnmarginright" id={'stop'+index}>Stop <i className="fa fa-stop" aria-hidden="true"></i></button>
                  <input type="hidden" id={'hid'+index} />
                  <button className="btn btn-success" id={'btSave'+ index} onClick={this.saveAudio}> Save <i className="fa fa-floppy-o" aria-hidden="true"></i></button>
               </div>
                  <section id={'sound-clips'+index}></section>
            </div>
            );
    }
});
//rewrite
var QuestionTypeRW = React.createClass({
    /**
     * khen anything up in this input will automate update into state
     * @returns {}
     */
    inputChange: function () {
        var index = this.props.idRW;
        var answer = $('#' + index).val();
        if (!!answer) {
            index = index.replace("RW", "");
            var mch = index;
            this.props.onCheck(mch, answer, "RW");
        }
    },
    render: function () {
        return (
            <div style={{'marginLeft':'15%'}}>
                <label> <b>&#8594;</b></label>
                <input id={this.props.idRW} type="text" onBlur={this.inputChange} className="inputRW" />
            </div>
            );
    }
});

//writing answer
var Writing = React.createClass({
    /**
    * when any key up on this field will auto update and put it into listAstudentanswer
    * @returns {}
    */
    onSubmit: function () {
        //   debugger
        var index = this.props.id;
        var answer = $('#' + index).val();
        if (!!answer) {
            log.show("writing sent", true);
            index = index.replace("WR", "");
            var mch = index;
            this.props.onCheck(mch, answer, "WR");
        }
    },
    render: function () {
        var index = this.props.id;
        return (
            <div>
               <textarea id={index} className="form-control flex-item textareawriting" onBlur ={this.onSubmit}></textarea>
            </div>
            );
}
});
ReactDOM.render(<App />, document.getElementById('container'));
